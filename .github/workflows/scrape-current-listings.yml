name: Scrape Current Listings

on:
  # Run every 6 hours
  schedule:
    - cron: '0 */6 * * *'  # At minute 0 past every 6th hour (00:00, 06:00, 12:00, 18:00 UTC)

  # Allow manual trigger
  workflow_dispatch:

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow workflow to push commits

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        pip install beautifulsoup4 requests

    - name: Scrape current listings
      run: |
        python3 scraper_current_listings.py
        echo "‚úÖ Scraping completed"

    - name: Regenerate website
      run: |
        python3 update_site_compact.py
        echo "‚úÖ Website regenerated"

    - name: Check for changes
      id: check_changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
        else
          echo "changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add current_listings.json output/
        git commit -m "$(cat <<'EOF'
        Auto-update: Current listings scraped $(date +"%Y-%m-%d %H:%M UTC")

        ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

        Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
        EOF
        )"
        git push origin main

    - name: No changes detected
      if: steps.check_changes.outputs.changes == 'false'
      run: echo "‚ÑπÔ∏è No changes to commit"

    - name: Deploy to OVH via FTP
      if: steps.check_changes.outputs.changes == 'true'
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./output/
        server-dir: /prixretro/
        log-level: verbose
        exclude: |
          .git*
          .github/
          __pycache__/
          *.py
          *.md
